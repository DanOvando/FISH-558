---
title: "FISH 558 Homework 5"
author: "Dan Ovando"
date: "November 13, 2015"
output: html_document
runtime: shiny
---

```{r global_options, include=FALSE}
# rm(list = ls())

set.seed(54321)

run <- '1.1'

run_folder <- paste('Results/',run,'/',sep = '')

run_sims <- T

if (dir.exists(run_folder) == F){dir.create(run_folder, recursive = T)}

library(knitr)
knitr::opts_chunk$set(fig.path='Figs/', echo=FALSE, warning=FALSE, message=FALSE)
library(gridExtra)
library(ggplot2)
library(plyr)
library(dplyr)
library(tidyr)
library(broom)
library(foreach)
library(scales)
library(stargazer)
library(mvtnorm)
library(proftools)
library(shiny)
library(doMC)
library(DT)
# source('moments_to_shape.R')
```

```{r functions}

#' Convert moment to shape parameters
#'
#' \code{moments_to_shape} takes the mean and cv
#' of a beta distribution and converts it to the shape
#' parameters
#' @param mu the mean of the beta distribution
#' @param cv the cv of the beta distribution

moments_to_shape <- function(mu,cv)
{
  
  var <- (mu*cv)^2 #calculate variance
  
  a <- (((1/mu - 1)*mu^3)/var) - mu
  
  b <- a*(1/mu - 1)
  
  #   a <- ( (1-mu)/var - 1/mu )*mu^2
  #   
  #   b <- a*(1/mu - 1)
  
  if (mu >=1){warning('mu is greater than or equal to 1, reduce it!')}
  
  return(list(shape1 = a, shape2 = b))
}

#' runs problembeast model
#'
#'\code{sim_problembeast} simulates populations of
#'the endangered problembeast forward under
#'different states of nature and hunting
#'@param pb a list of problembeast population
#'parameters
#'@param sim_years number of years to run
#'@param hunted_patch the patch in which hunting
#'occurs
#'@param s_j juvenile survival
#'@param _value the price per hunted animal
#'at various ages
#'@param results blank matrix to store results
#'@param recruits index of recruits
#'@param juveniles index of juveniles
#'@param adults index of all adults
#'@param mature index of mature adults
#'@param plus index of the plus group
#'
sim_problembeast <- function(pb,sim_years = 101,hunted_patch = 0,s_j = .75,
                             recruit_value = 1, juv_value = 5, adult_value = 30,
                             results, recruits,juveniles,adults,mature,plus)
{
  
  pb$s_j <- s_j #input juvenile survival
  
  results$year <- 1:(sim_years+1) #input yeats
  
  results$hunted_patch <- hunted_patch #mark hunted patch
  
  results$s_j <- s_j #store juvenile survival
  
  phi <- matrix(1, nrow = 3, ncol = sim_years)
  
  if (hunted_patch>0){ # If there is any hunting generate a vector of hunting survivals over time for the appropriate patch
    
    shape1 <- eval(parse(text = paste('pb$phi_',hunted_patch,'_shape',sep = '') ))$shape1
    
    shape2 <- eval(parse(text = paste('pb$phi_',hunted_patch,'_shape',sep = '') ))$shape2
    
    phi[hunted_patch,] <-  rbeta(sim_years,shape1 = shape1, shape2 = shape2)
    
    
  }
  
  #Store initial conditions
  
  n_adults <- sum(pb$n_at_age[1, mature])
  
  results$adults[1] <- n_adults
  
  pb$n_at_age <- as.matrix(pb$n_at_age)
  
  for (y in 1:(sim_years)) #loop away
  {
    
    # Juvenile component ----
    
    juv_survive <- rbinom(length(juveniles),(pb$n_at_age[y,juveniles - 1]),pb$s_j)
    
    juv_survive_hunting <- rbinom(length(juveniles),(juv_survive),phi[2,y])
    
    juv_hunted <- juv_survive - juv_survive_hunting
    
    pb$n_at_age[y + 1,juveniles] <- juv_survive_hunting
    
    # Adult component ----
    
    adults_survive <- rbinom(length(adults),(pb$n_at_age[y,adults - 1]),pb$s_a)
    
    adults_survive_hunting <- rbinom(length(adults), (adults_survive),phi[3,y])
    
    adults_hunted <- adults_survive - adults_survive_hunting
    
    pb$n_at_age[y + 1, adults] <- adults_survive_hunting
    
    # Plus group component ---
    
    enter_plus_survive <- rbinom(length(plus),(pb$n_at_age[y,plus - 1]),pb$s_a)
    
    enter_plus_survive_hunting <- rbinom(length(plus), (enter_plus_survive),phi[3,y])
    
    enter_plus_hunted <- enter_plus_survive - enter_plus_survive_hunting
    
    enter_plus <- enter_plus_survive_hunting
    
    stay_plus_survive <- rbinom(length(plus),(pb$n_at_age[y,plus]),pb$s_a)
    
    stay_plus_survive_hunted <- rbinom(length(plus), (stay_plus_survive),phi[3,y])
    
    stay_plus_hunted <- stay_plus_survive - stay_plus_survive_hunted
    
    stay_plus <- stay_plus_survive_hunted
    
    pb$n_at_age[y + 1, plus] <- enter_plus + stay_plus
    
    n_adults <- sum(pb$n_at_age[y + 1, mature])
    
    # Recruitment comonent ----
    
    recruits_born <- rbinom(length(recruits), n_adults, pb$b)
    
    recruits_survive_hunting <- rbinom(length(recruits), recruits_born,phi[1,y])
    
    recruits_hunted <- recruits_born - recruits_survive_hunting
    
    pb$n_at_age[y + 1,recruits] <- recruits_survive_hunting
    
    results$adults[y+1] <- n_adults
    
    # Process hunting ----
    
    hunted_in_two <- sum(juv_hunted)
    
    hunted_in_three <- sum(adults_hunted) + sum(enter_plus_hunted) + sum(stay_plus_hunted)
    
    hunted <-  hunted_in_two + hunted_in_three
    
    hunted_value <- hunted_in_two * juv_value + hunted_in_three * adult_value
    
    if (hunted_patch >1){
      results$hunted[y] <- hunted
      results$hunt_value[y] <- hunted_value
    }
    if(hunted_patch == 1)
    {
      results$hunted[y + 1] <- recruits_hunted
      results$hunt_value[y+1] <- recruits_hunted * recruit_value
    }
    
  } #close year loop
  
  results <- results[1:sim_years,]
  
  return(results)
  
}

```


The goal of this assignment is to provide and MSE/decision analysis around the management of a mythical endangered species. There is uncertainty around parameters and a variety of potential management actions that need considering. 

```{r define problembeast parameters}

sim_years <- 101

ages <- 16

n_sims <- 1000

problembeast <- list()

problembeast$n_at_age <- as.data.frame(matrix(NA,nrow = sim_years+1, ncol = ages + 1))

colnames(problembeast$n_at_age) <- c('year',paste('age.',0:(ages-1), sep = ''))

problembeast$n_at_age[1,] <- c(1,98, 68, 48, 38, 27, 24, 16, 11, 
                               12, 13, 3, 11, 1, 5, 2, 113)

problembeast$s_j <- NA

problembeast$s_a <- 0.95

problembeast$b <- 0.75

problembeast$phi_1_mean <- 0.7

problembeast$phi_1_cv <- 0.1

problembeast$phi_1_shape <- moments_to_shape(mu = problembeast$phi_1_mean,cv = problembeast$phi_1_cv)


problembeast$phi_2_mean <- 0.95

problembeast$phi_2_cv <- 0.1

problembeast$phi_2_shape <- moments_to_shape(mu = problembeast$phi_2_mean,cv = problembeast$phi_2_cv)

problembeast$phi_3_mean <- 0.97

problembeast$phi_3_cv <- 0.1

problembeast$phi_3_shape <- moments_to_shape(mu = problembeast$phi_3_mean,cv = problembeast$phi_3_cv)


resultnames <- c('year','adults','hunted','hunt_value','hunted_patch','s_j')

resultmat <- as.data.frame(matrix(0,nrow = sim_years+1,ncol = length(resultnames)))

colnames(resultmat) <- resultnames

recruits <- which(colnames(problembeast$n_at_age) %in% 'age.0')

juveniles <- which(colnames(problembeast$n_at_age) %in% paste('age',1:8,sep = '.'))

adults <- which(colnames(problembeast$n_at_age) %in% paste('age',9:14,sep = '.'))

mature <- which(colnames(problembeast$n_at_age) %in% paste('age',9:15,sep = '.'))

plus <- which(colnames(problembeast$n_at_age) == 'age.15')

# a <- proc.time()
# b <- sim_problembeast(pb = problembeast,results = results,recruits = recruits,juveniles = juveniles,adults = adults, mature = mature, plus = plus)
# proc.time() - a

```

## Task A

Find the relationship between the mean and CB of a beta distribution and the shape 1 and shape 2 parameters for rbeta. The goal here is to take the mean and CV parameters for the beta distribution provided by Andre and convert them into R usable form. 

The beta distribution is defined by

1) $$ \frac{\Gamma(a+b)}{\Gamma(a)\Gamma(b)} x^{a-1}(1-x)^{b-1}$$

where *a* and *b* are > 0 and the "shape1" and "shape2" parameters. The mean of the beta distribution is given as 

2) $$ \mu = \frac{a}{a+b} $$ 

given a CV the variance is then

3) $$ \sigma^2 = ({CV}\mu)^2 $$

and the variance is given as 

4) $$ \sigma^2 = \frac{ab}{(a+b)^{2}(a+b+1)} $$

we can use Eq.2 to define *b* as 

5) $$ b = a(1/\mu - 1) $$

substituting Eq.4 into Eq.3 we obtain

6) $$ \sigma^2 = \frac{a^{2}(1/\mu - 1)}{(a/\mu)^{2}(a/\mu + 1)} $$

which simplifies to 

7) $$ \sigma^2 = \frac{(1/\mu - 1)}{(a+\mu)/\mu^{3}} $$

which we can rearrange to solve for *a* as 

8) $$ a =  \frac{(1/\mu - 1)\mu^{3}}{\sigma^2} - \mu $$

we can then calculate *b* through Eq.5

## Part B

Coding up equations 1:8, we obtain the following function

```{r, echo=T}
moments_to_shape <- function(mu,cv)
{
  
  var <- (mu*cv)^2 #calculate variance
  
  a <- (((1/mu - 1)*mu^3)/var) - mu
  
  b <- a*(1/mu - 1)
  
  if (mu >=1){warning('mu is greater than or equal to 1, reduce it!')}
  
  return(list(shape1 = a, shape2 = b))
}

```

which can be examined through Fig.1

```{r converted beta example, echo=FALSE}
inputPanel(
  sliderInput("mu", label = "Mean:",
              min = 0, max = .9, value = .5, step = 0.01),
  
  sliderInput("cv", label = "CV:",
              min = 0, max = 1.5, value = .5, step = 0.01)
)

renderPlot({
  
  plotseq <- seq(0.01,1,by = .01)
  
  shapes <- moments_to_shape(mu = input$mu,cv = input$cv)
  
  name <- paste('a = ',round(shapes$shape1,2),', b = ',round(shapes$shape2,2),sep = '')
  
  plot(plotseq,dbeta(plotseq,shape1 = shapes$shape1,shape2 = shapes$shape2),xlab = '',ylab = 'pdf', type = 'l',lwd = 2)
  title(main = name)
  
})
```

## Part C

```{r run sims, cache = F}

sims <- expand.grid(s_j = c(0.75,0.8,0.82),hunted_patch = c(0,1,2,3),sim = 1:n_sims)

run_sim <- function(j,sims,problembeast,resultmat,recruits,juveniles,adults,plus,mature)
{
  out <- sim_problembeast(pb = problembeast,
                          hunted_patch = sims$hunted_patch[j],s_j = sims$s_j[j], results = resultmat,juveniles = juveniles,adults = adults, mature = mature, plus = plus,recruits = recruits)
  
  out$sim <- j
  
  
  return(out)
}

if (run_sims == T){
  registerDoMC(cores=4)
  
  
  results <- (foreach(i = 1:dim(sims)[1]) %dopar%
                (run_sim(i,sims = sims,problembeast = problembeast, resultmat = resultmat,juveniles = juveniles,
                         adults = adults, mature = mature, plus = plus, recruits = recruits)))
  
#   save(file = paste(run_folder,'problembeast simulations.Rdata',sep = ''), results)
}else{
#   load(file = paste(run_folder,'problembeast simulations.Rdata',sep = ''))
}

tidy_results <- ldply(results)

decision_table <- tidy_results %>%
  subset(year == 101) %>%
  group_by(s_j,hunted_patch) %>%
  summarize(mean_adults = mean(adults),p_lessthan_1000 = mean(adults < 1000), mean_value = mean(hunt_value)) %>%
  ungroup() %>%
  group_by(hunted_patch) %>%
  mutate(expected_adults = mean(mean_adults), expected_p_lt_1000 = mean(p_lessthan_1000),
         expected_value = mean(mean_value)) %>%
  ungroup() %>%
  mutate(state_of_nature = paste('juv survival = ',s_j, sep = ''))

decision_table1 <- select(decision_table, state_of_nature,hunted_patch,mean_adults,expected_adults) %>%
  spread(state_of_nature,mean_adults) %>%
  mutate('Expected Adults' = expected_adults) %>%
  select(-expected_adults) %>%
  rename('Hunted Patch' = hunted_patch)

decision_table2 <- select(decision_table, state_of_nature,hunted_patch,p_lessthan_1000,expected_p_lt_1000) %>%
  spread(state_of_nature,p_lessthan_1000) %>%
  mutate('Expected p(A < 1000)' = expected_p_lt_1000) %>%
  select(-expected_p_lt_1000) %>%
  rename('Hunted Patch' = hunted_patch)

decision_table_value <- select(decision_table, state_of_nature,hunted_patch,mean_value,expected_value) %>%
  spread(state_of_nature,mean_value) %>%
  mutate('Expected Hunting Value' = expected_value) %>%
  select(-expected_value) %>%
  rename('Hunted Patch' = hunted_patch)

tradeoff <- (ggplot(decision_table,aes(mean_adults,mean_value, shape = factor(hunted_patch),color = s_j)) + 
               geom_point(size = 4, alpha = 0.75) + 
               #                geom_line(aes(mean_adults,mean_value,color = s_j)) + 
               scale_color_gradient(low = 'red',high = 'green') + 
               theme_light())

tradeoff2 <- (ggplot(subset(decision_table, hunted_patch >0),aes(1-p_lessthan_1000,mean_value,fill = factor(hunted_patch))) + 
                geom_point(shape = 21, size = 4, alpha = 0.75) + 
                scale_fill_brewer(name = 'Hunted Patch',palette = 'Spectral') + 
                facet_grid(state_of_nature~., scales = 'free') + 
                theme_light() + 
                xlab('P(Adults > 1000)') + 
                ylab('Value of Hunting'))

tradeoff3 <- (ggplot(subset(decision_table, hunted_patch >0),aes(1-expected_p_lt_1000,expected_value,fill = factor(hunted_patch))) + 
                geom_point(shape = 21, size = 4, alpha = 0.75) + 
                scale_fill_brewer(name = 'Hunted Patch',palette = 'Spectral') + 
                #                 facet_grid(state_of_nature~., scales = 'free') + 
                theme_light() + 
                xlab('P(Adults > 1000)') + 
                ylab('Value of Hunting'))

tidy_results$hunted_patch_name <- paste('Hunted Patch = ',tidy_results$hunted_patch, sep = '')

outcome_plot <- subset(tidy_results, year == 101) %>%
  ggplot(aes(adults, fill = factor(s_j))) +
  geom_density(alpha = 0.75) + 
  facet_wrap(~hunted_patch_name, scales = 'free_y') + 
  theme_light() + 
  scale_fill_brewer(name = 'Juvenile Survival',palette = 'Spectral') + 
  xlab('Number of Adults') + 
  ylab('Density')


# tradeoff

# tradeoff2

```

```{r population dynamics, echo=FALSE}
inputPanel(
  selectInput("hunted_patch", label = "Hunted Patch:",
              choices = c(0,1,2,3), selected = 1),
  
  sliderInput("s_j", label = "Juvenile Survival:",
              min = 0.5, max = 1, value = .8, step = 0.01)
)

renderPlot({
  
  simmed <- sim_problembeast(pb = problembeast,
                             hunted_patch = as.numeric(input$hunted_patch),s_j = input$s_j, results = resultmat,juveniles = juveniles,adults = adults, mature = mature, plus = plus,recruits = recruits)
  
  simplot <- ggplot(simmed, aes(year, adults, fill = hunt_value)) + 
    geom_point(shape = 21) + 
    xlab('Year') + 
    ylab('Number of Adults') + 
    theme_light() + 
    geom_hline(aes(yintercept = 1000), linetype = 'longdash') + 
    scale_fill_continuous(name = 'Value of Hunting',low = 'orange', high = 'green')
  
  simplot
  
})
```


```{r distributions, fig.cap='distributions of adult animals'}

outcome_plot

```

For all analyses we assume that the three states of nature related to juvenile survival are all equally likely. Considering the expected number of adults after 100 years (in year 101), we see unsurprisingly that the number of adults is linearly and positively correlated with the juvenile survival rate: the higher the natural rate of juvenile, the more adults (Table.1). From the perspective of a hunting strategy, any of the proposed hunting strategies dramatically reduce the expected number of adults compared to the no hunting scenario. If our objective is to maximize the number of expected adults across the three evaluated states of nature, conditional on allowing hunting in at least one patch, the optimal hunting strategy is to allow hunting in patch 1, in which new recruits are hunted. The next best strategy is to allow hunting in patch three, there the mature adults are targeted, followed by hunting in patch 2 (juvenile hunting). 

```{r decision table 1}

kable(decision_table1, caption = 'Table.1: Decision table considering numbers of adult (ages 9-14) problembeasts across three states of nature under four hunting strategies', digits = 2)

```

If we instead consider the probability that there are less than 1000 adult (ages 9-15) problembeasts in the population we see similar outcomes as when considering the expected number of adults (Table.2). We do see far less of a difference in expected outcomes between no hunting and hunting, meaning that the consequences of allowing hunting of any kind may be less severe if our only objective is ensuring that more than 1000 adults are present in 100 years. We also see essentially no difference between allowing hunting in patch 2 and patch 3. Interestingly, we under the state of nature in which juvenile natural survival is 0.75 there is 0% probability of an adult population greater than 1000. 


```{r decision table 2}

kable(decision_table2, caption = 'Table.2: Decision table considering the probability that the number of adult (ages 9-14) problembeasts is less than 1000 across three states of nature under four hunting strategies', digits = 2)

```

## Task D

Considering now the value of hunting, we can first analyze a decision table based around hunting value (Table.3). Assuming equal probability of each of the states of nature, the best option for a manager seeking to maximize hunting value in 100 years is to allow hunting in patch 3, regardless of the true state of nature. 

```{r value table}

kable(decision_table_value, digits = 2, caption = 'Table.3: Decision table considering the value derived from hunting accross three states of nature under four hunting strategies. The probabilitiy of each state of nature is the same.')

```

However, the question of which strategy (conditional on allowing some hunting) is "best" depends on the objectives of management. Examining a tradeoff analysis of the probability of more than 1000 adults (P(Adults >1000): 1 - P(A < 1000)) in 100 years and the value of hunting, we see that there are clear tradeoffs between these two objectives (Fig.XX, hover over figure for caption) depending on the state of nature. The recommendation to a manager will depend on the extent to which they value hunting profits relative to P(Adults>1000). If juvenile survival is 0.7, and our only conservation objective is P(Adults >1000), then the optimal strategy is to allow hunting in patch 3, since it introduces the most value from hunting and produces the same conservation outcome as the other hunting strategies. 

If juvenile survival is 0.8, we see that allowing hunting in patch two is a dominated solution: no matter if the manager prefers conservation or hunting profits hunting in patch 2 is sub-optimal, and either hunting in patch 1 or 3 will produce better outcomes for either objective. Hunting in patch 1 provides a greater outcome for conservation, patch 3 provides a better outcome from the perspective of profits. 

If juvenile survival is 0.82 we see linear tradeoffs, where the choice of which patch to hunt is strictly defined by the weighting of the objective function, with patch 3 hunting providing the greatest profits, patch 1 hunting the greatest conservation outcome, and patch 2 providing a balanced outcome between the two objectives. 

```{r tradeoff, fig.cap='Tradeoff analysis of probability of more than 1000 adults vs. value of hunting over three states of nature'}
tradeoff2
```

We can consider this tradeoff analysis across all states of nature, assuming equal probability of the three states evaluated. Under this scenario, the expected P(Adults > 1000) and value of hunting is the average of the P(Adults > 1000) and value of hunting across the three states of nature. We see that if we are completely uncertain as to the state of nature, and all are equally likely, then we would never recommend hunting in patch 2 to a manager, since that strategy is completely dominated by the other hunting options (Fig.XX). The choice between hunting in patch 1 or 3 would then depend on the objective function of the managers. Patch 3 would be preferable if the manager favors hunting value, Patch 1 if the manager prefers conservation outcomes. We could of course repeat this exercise considering the raw number of adults as our objectives, or a three way objective function. 


```{r tradeoff_2huh, fig.cap= 'Tradeoff analysis of probability of more than 1000 adults vs. value of hunting integrating over three states of nature'}

print(tradeoff3)

```

## Task E

Taking this question to mean that we are interested in the value of information on s~j~, conditional on picking a harvest strategy that maximizes the expected number of adults in 100 years. Assume that all three states of nature are equally likely.The management decision on the table is which patch should be open to hunting, with the stipulation that some hunting occurs. We would measure the value of information under this scenario as the mean of the expected values of hunting under the hunting policy that maximizes the number of adults in 100 years under each state of nature, relative to the expected value of the hunting policy that maximizes the expected number of adults across all three states of nature. 

In other words, we are comparing the hunting value of being able to choose the appropriate hunting strategy that maximizes the number of adults given perfect knowledge of the state of nature, compared to having to pick one hunting strategy that performs best in maximizing the expected number of adults in 100 years across all possible states of nature. 

However, we see from Table.1 that the harvest strategy that maximizes the expected number of adults in 100 years under any state of nature is hunting in patch 1 (i.e. targeting new recruits). Therefore, with no information on the actual state of nature, we would pick hunting in patch 1 if our objective is maximizing the number of adults. But, if we had perfect information, we would also pick hunting in patch 1 under any state of nature, if the objective is maximizing the adults in 100 years. Therefore, the value of information is $0. We gain no additional management insight, and associated value, by knowing perfectly what *s~j~* is, since we would make the exact same management decision with no information on *s~j~*, if the objective is maximizing the expected number of adults in 100 years. 

```{r}


# decision_table <- tidy_results %>%
#   subset(year == 100 & hunted_patch>0) %>%
#   group_by(hunted_patch) %>%
#   summarize(mean_adults = mean(adults),p_morethan_1000 = mean(adults >= 1000), mean_value = mean(hunt_value)) %>%
#   arrange(-mean_adults)

```


```{r}

# decision_table <- tidy_results %>%
#   subset(year == 100 & hunted_patch>0) %>%
#   group_by(s_j,hunted_patch) %>%
#   summarize(mean_adults = mean(adults),p_morethan_1000 = mean(adults >= 1000), mean_value = mean(hunt_value)) %>%
#   arrange(-mean_adults) %>%
#   ungroup() %>%
#   group_by(s_j) %>%
#   mutate(best_hunt = mean_adults == max(mean_adults)) %>%
#   subset(best_hunt == T) %>%
#   ungroup() %>%
#   mutate(expected_value = mean(mean_value))

```
